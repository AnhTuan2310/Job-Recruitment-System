<script type="text/javascript">
  var gk_isXlsx = false;
  var gk_xlsxFileLookup = {};
  var gk_fileData = {};
  function filledCell(cell) {
    return cell !== "" && cell != null;
  }
  function loadFileData(filename) {
    if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
      try {
        var workbook = XLSX.read(gk_fileData[filename], { type: "base64" });
        var firstSheetName = workbook.SheetNames[0];
        var worksheet = workbook.Sheets[firstSheetName];

        // Convert sheet to JSON to filter blank rows
        var jsonData = XLSX.utils.sheet_to_json(worksheet, {
          header: 1,
          blankrows: false,
          defval: "",
        });
        // Filter out blank rows (rows where all cells are empty, null, or undefined)
        var filteredData = jsonData.filter((row) => row.some(filledCell));

        // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
        var headerRowIndex = filteredData.findIndex(
          (row, index) =>
            row.filter(filledCell).length >=
            filteredData[index + 1]?.filter(filledCell).length
        );
        // Fallback
        if (headerRowIndex === -1 || headerRowIndex > 25) {
          headerRowIndex = 0;
        }

        // Convert filtered JSON back to CSV
        var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
        csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
        return csv;
      } catch (e) {
        console.error(e);
        return "";
      }
    }
    return gk_fileData[filename] || "";
  }
</script>
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản Lý Người Dùng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      alert("⛔ Bạn chưa đăng nhập!");
      window.location.href = "/login";
    }
  </script>

  <body class="min-h-screen bg-gray-100">
    <div class="container mx-auto py-8 px-4">
      <h1 class="text-3xl font-bold text-center text-blue-600 mb-8">
        Quản Lý Người Dùng
      </h1>

      <table id="userTable" class="min-w-full bg-white border">
        <thead>
          <tr class="bg-blue-100">
            <th class="py-2 px-4 border">ID</th>
            <th class="py-2 px-4 border">Tên Đăng Nhập</th>
            <th class="py-2 px-4 border">Họ Tên</th>
            <th class="py-2 px-4 border">Email</th>
            <th class="py-2 px-4 border">Vai Trò</th>
            <th class="py-2 px-4 border">Hành Động</th>
          </tr>
        </thead>
        <tbody id="userBody"></tbody>
      </table>

      <!-- Form sửa -->
      <div id="editForm" class="mt-8 bg-white p-6 rounded shadow hidden">
        <h2 class="text-xl font-bold mb-4">Sửa Thông Tin Người Dùng</h2>
        <input type="hidden" id="editId" />
        <div class="grid grid-cols-1 gap-4">
          <input
            type="text"
            id="editUsername"
            placeholder="Tên đăng nhập"
            class="border p-2 rounded"
          />
          <input
            type="text"
            id="editFullName"
            placeholder="Họ tên"
            class="border p-2 rounded"
          />
          <input
            type="email"
            id="editEmail"
            placeholder="Email"
            class="border p-2 rounded"
          />
          <select id="editRole" class="border p-2 rounded">
            <option value="ADMIN">Admin</option>
            <option value="COMPANY">Company</option>
            <option value="APPLICANT">Applicant</option>
          </select>
          <input
            type="password"
            id="editPassword"
            placeholder="Mật khẩu (bỏ trống nếu không đổi)"
            class="border p-2 rounded"
          />
        </div>
        <button
          onclick="saveUser()"
          class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
        >
          Lưu
        </button>
      </div>
      <button
        style="margin-top: 10px"
        onclick="window.location.href='trangchu'"
        class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600"
      >
        Trang Chủ
      </button>
    </div>
    <script>
      const API_BASE_URL = "/api/users";

      async function loadUsers() {
        const token = localStorage.getItem("token");
        const response = await fetch(API_BASE_URL, {
          headers: { Authorization: "Bearer " + token },
        });
        const users = await response.json();
        const tbody = document.getElementById("userBody");
        tbody.innerHTML = "";

        users.forEach((user) => {
          const tr = document.createElement("tr");
          tr.classList.add("hover:bg-gray-50");
          tr.innerHTML = `
        <td class="border px-4 py-2">${user.id}</td>
        <td class="border px-4 py-2">${user.username}</td>
        <td class="border px-4 py-2">${user.full_name}</td>
        <td class="border px-4 py-2">${user.email}</td>
        <td class="border px-4 py-2">${user.role}</td>
        <td class="border px-4 py-2">
          <button class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded mr-1" onclick="editUser(${user.id}, '${user.username}', '${user.full_name}', '${user.email}', '${user.role}')">Sửa</button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded" onclick="deleteUser(${user.id})">Xóa</button>
        </td>`;
          tbody.appendChild(tr);
        });
      }

      function editUser(id, username, fullName, email, role) {
        document.getElementById("editForm").classList.remove("hidden");
        document.getElementById("editId").value = id;
        document.getElementById("editUsername").value = username;
        document.getElementById("editFullName").value = fullName;
        document.getElementById("editEmail").value = email;
        document.getElementById("editRole").value = role;
        document.getElementById("editPassword").value = "";
        document.getElementById("editForm").scrollIntoView();
      }

      async function saveUser() {
        const token = localStorage.getItem("token");
        const id = document.getElementById("editId").value;
        const username = document.getElementById("editUsername").value;
        const full_name = document.getElementById("editFullName").value;
        const email = document.getElementById("editEmail").value;
        const role = document.getElementById("editRole").value;
        const password = document.getElementById("editPassword").value;

        const payload = { username, full_name, email, role };
        if (password.trim()) {
          payload.password = password;
        }

        const res = await fetch(`${API_BASE_URL}/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify(payload),
        });

        if (res.ok) {
          alert("✅ Cập nhật thành công!");
          document.getElementById("editForm").classList.add("hidden");
          loadUsers();
        } else {
          const err = await res.text();
          alert("❌ Lỗi: " + err);
        }
      }

      async function deleteUser(id) {
        if (!confirm("Bạn có chắc muốn xóa người dùng này?")) return;

        const token = localStorage.getItem("token");
        const res = await fetch(`${API_BASE_URL}/${id}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token },
        });

        if (res.ok) {
          alert("✅ Xóa thành công!");
          loadUsers();
        } else {
          const err = await res.text();
          alert("❌ Lỗi khi xóa: " + err);
        }
      }

      window.onload = loadUsers;
    </script>
  </body>
</html>
